#!/bin/bash
# ==========================================
# NextGen VPS Installer v1.0
# Modern & Improved VPS Setup Script
# ==========================================
clear
cd $HOME

# ==========================================
# Variables
# ==========================================
RutaBin="/bin"
RESOLV_CONF="/etc/resolv.conf"
TIMEZONE="America/Mexico_City"
VPS_DIR="/etc/NextGen"
MENU_BIN="/usr/bin/nextgen"

# ==========================================
# Colors
# ==========================================
RED='\033[1;31m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
BLUE='\033[1;34m'
CYAN='\033[1;36m'
WHITE='\033[1;37m'
BOLD='\033[1m'
RESET='\033[0m'

bar() { echo -e "${RED}————————————————————————————————————————————${RESET}"; }

msg() {
    case $1 in
        -ok) echo -e "${GREEN}[✔] $2${RESET}" ;;
        -err) echo -e "${RED}[✖] $2${RESET}" ;;
        -info) echo -e "${CYAN}[i] $2${RESET}" ;;
        -warn) echo -e "${YELLOW}[!] $2${RESET}" ;;
        -bar) bar ;;
    esac
}

fun_bar() {
    comando="$1"
    _=$($comando >/dev/null 2>&1) &
    pid=$!
    while [[ -d /proc/$pid ]]; do
        echo -ne "${YELLOW}[${RED}■■■■■■■■■■■■■■■■■■■■${YELLOW}]${RESET} \r"
        sleep 0.5
    done
    echo -e "${GREEN}[✔] 100%${RESET}"
    sleep 1
}

# ==========================================
# Network & Timezone Setup
# ==========================================
msg -info "Configuring DNS & Network..."
echo -e "nameserver 1.1.1.1\nnameserver 1.0.0.1" > $RESOLV_CONF
myip=$(hostname -I | awk '{print $1}')
myint=$(ip route | grep $myip | awk '{print $3}')
rm -f /etc/localtime
ln -s /usr/share/zoneinfo/$TIMEZONE /etc/localtime
msg -ok "Network & timezone configured."

# ==========================================
# Package Installation
# ==========================================
install_packages() {
    msg -bar
    msg -info "Installing Required Packages..."
    apt update -y &>/dev/null
    packages=(net-tools netcat grep gawk mlocate lolcat at nano bc lsof figlet cowsay screen python3 python3-pip ufw unzip zip apache2)
    for pkg in "${packages[@]}"; do
        if ! dpkg -s $pkg &>/dev/null; then
            apt install -y $pkg &>/dev/null
            [[ $? -eq 0 ]] && msg -ok "Package $pkg installed." || msg -err "Failed to install $pkg."
        else
            msg -info "Package $pkg already installed."
        fi
    done
    # Configure Apache port
    sed -i "s;Listen 80;Listen 81;" /etc/apache2/ports.conf
    systemctl restart apache2
}
install_packages

# ==========================================
# Directory Setup
# ==========================================
msg -info "Creating NextGen directories..."
dirs=(
    $VPS_DIR
    $VPS_DIR/tools
    $VPS_DIR/v2ray
    $VPS_DIR/slowdns
    /usr/local/lib/nextgen
    /usr/share/nextgen/logs
)
for d in "${dirs[@]}"; do
    [[ ! -d $d ]] && mkdir -p $d
done
msg -ok "Directories created."

# ==========================================
# Menu Script Setup
# ==========================================
echo -e "#!/bin/bash\nclear\nfiglet NextGen VPS\necho 'Welcome to NextGen VPS Panel!'" > $VPS_DIR/menu.sh
chmod +x $VPS_DIR/menu.sh
echo $VPS_DIR/menu.sh > $MENU_BIN
chmod +x $MENU_BIN

# ==========================================
# Bash Profile Customization
# ==========================================
echo 'clear' >> ~/.bashrc
echo 'echo -e "\t\033[1;36mWelcome to NextGen VPS\033[0m"' >> ~/.bashrc
echo 'echo -e "\tType: nextgen or menu to start panel"' >> ~/.bashrc

# ==========================================
# Final Message
# ==========================================
msg -bar
echo -e "${GREEN}Installation Complete!${RESET}"
echo -e "${CYAN}Use the command 'nextgen' or 'menu' to access your VPS panel.${RESET}"
msg -bar
